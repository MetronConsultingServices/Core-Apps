#!/usr/bin/env node
var co = require('co');
var prompt = require('co-prompt');
var program = require('commander');
var EventEmitter = require("events").EventEmitter;
var evnt = new EventEmitter();

var models = require('./sampleobject');
 
program
    .arguments('<file>')
    .action(function(file) {
    co(function *() {
        var connectorFile = require(file);
        var operation = yield prompt('Operation (init/test): ');
        var option, optionType,connectorType;
        var credentialsList = {};
        var node = {};

        var credentialKeyString = yield prompt('Enter credentials key list split by comma: ');
        var credentialKeyList = credentialKeyString.split(',');

        for (var i = 0 ; i < credentialKeyList.length; i++) {
            var credentialValue = yield prompt('Enter value for ' + credentialKeyList[i] + ' : ');
            credentialsList[credentialKeyList[i]] = credentialValue;
        };

        node.credentials = credentialsList;

        if (operation.toLowerCase() == "init") {
            connectorType = yield prompt('Connector Type (trigger/action): ');
            option = yield prompt('Option : ');
            optionType = yield prompt('Option type : ');
            node.option = option;
            node.optionType = optionType;
            var obj = {
                fileName : file,
                type : connectorType
            }
            node.connector = obj;
            node.connection = obj.connection;
            if (connectorType == "action") {
                node.reqData = models[option];
            }
            connectorFile.init(node);
        } else if (operation.toLowerCase() == "test") {
            connectorFile.test(node,function(resObj){
                console.log("%j",resObj);
                process.exit(0);
            });
        }
    });
}).parse(process.argv);

evnt.on("error", function(message, postData, url, node){
    if (!node) {
        console.log("node not found in your success emit");
    } else if (!message) {
        console.log("'message' not found");
    } else if (!node.hasOwnProperty("connector")) {
        console.log("Node don't have a key 'connector");
    } else if (!node.connector.hasOwnProperty("type")) {
        console.log("Key 'type' is not exists in connector");
    } else if (!node.hasOwnProperty("reqData")) {
        console.log("Key 'reqData' is notfound in your data posted to 'error'");
    } else if (!node.reqData.hasOwnProperty("_id")) {
        console.log("Key '_id' is notfound in your data posted to 'error'");
    } else if (!node.hasOwnProperty("connection")) {
        console.log("Key 'connection' is notfound in your data posted to 'success'");
    } else {
        console.log("Error : "+message);
    }
});

evnt.on("success", function(node, message) {
    if (!node) {
        console.log("node not found in your success emit");
    } else if (!message) {
        console.log("'message' not found");
    } else if (!node.hasOwnProperty("connector")) {
        console.log("Node don't have a key 'connector");
    } else if (!node.connector.hasOwnProperty("type")) {
        console.log("Key 'type' is not exists in connector");
    } else {
        if (node.connector.type == "trigger") {
            if (!node.hasOwnProperty("resData")) {
                console.log("Key 'resData' is notfound in your data posted to 'success'");
            } else if (!Array.isArray(resData)) {
                console.log("Value of 'resData' is not an Array");
            } else {
                console.log("Data received from your connector is %j",node.resData);
            }
        } else if (node.connector.type == "action") {
            if (!node.hasOwnProperty("reqData")) {
                console.log("Key 'reqData' is notfound in your data posted to 'success'");
            } else if (!node.reqData.hasOwnProperty("_id")) {
                console.log("Key '_id' is notfound in your data posted to 'success'");
            } else if (!node.hasOwnProperty("connection")) {
                console.log("Key 'connection' is notfound in your data posted to 'success'");
            } else {
                console.log("Success : "+message);
            }
        }
    }
});

module.exports = evnt;
